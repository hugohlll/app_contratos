from django.shortcuts import render

from django.shortcuts import render
from django.db.models import Q
from .models import Contrato, Designacao

def pesquisa_publica(request):
    query = request.GET.get('q') # Pega o que o usuário digitou
    resultados = []

    if query:
        # Busca Contratos pelo número, objeto ou nome da empresa
        resultados = Contrato.objects.filter(
            Q(numero__icontains=query) | 
            Q(objeto__icontains=query) |
            Q(empresa__razao_social__icontains=query)
        ).distinct()

    return render(request, 'contratos/pesquisa.html', {
        'resultados': resultados,
        'query': query
    })

def detalhe_contrato(request, contrato_id):
    contrato = Contrato.objects.get(id=contrato_id)
    # Pega todas as designações ordenadas por data
    designacoes = contrato.designacoes.all().order_by('-data_inicio')
    
    return render(request, 'contratos/detalhe.html', {
        'contrato': contrato,
        'designacoes': designacoes
    })
