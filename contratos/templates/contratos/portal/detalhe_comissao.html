{% extends 'contratos/portal/base_portal.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">
                {% if object %}Editar Comiss√£o{% else %}Nova Comiss√£o{% endif %}
            </h2>
            <a href="{% url 'listar_comissoes' %}" class="btn btn-outline-secondary">
                ‚Üê Voltar para Lista
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-5">
        <div class="card card-custom">
            <div class="card-header bg-light">
                <h5 class="mb-0">Dados da Comiss√£o</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.contrato.id_for_label }}" class="form-label fw-bold">
                                {{ form.contrato.label }}
                            </label>
                            {{ form.contrato }}
                            {% if form.contrato.errors %}
                            <div class="text-danger small">{{ form.contrato.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.tipo.id_for_label }}" class="form-label fw-bold">
                                {{ form.tipo.label }}
                            </label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                            <div class="text-danger small">{{ form.tipo.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.portaria_numero.id_for_label }}" class="form-label fw-bold">
                                {{ form.portaria_numero.label }}
                            </label>
                            {{ form.portaria_numero }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.portaria_data.id_for_label }}" class="form-label fw-bold">
                                {{ form.portaria_data.label }}
                            </label>
                            {{ form.portaria_data }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.boletim_numero.id_for_label }}" class="form-label fw-bold">
                                {{ form.boletim_numero.label }}
                            </label>
                            {{ form.boletim_numero }}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.boletim_data.id_for_label }}" class="form-label fw-bold">
                                {{ form.boletim_data.label }}
                            </label>
                            {{ form.boletim_data }}
                        </div>
                    </div>

                    <div class="row align-items-end">
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.data_inicio.id_for_label }}" class="form-label fw-bold">
                                {{ form.data_inicio.label }}
                            </label>
                            {{ form.data_inicio }}
                            {% if form.data_inicio.errors %}
                            <div class="text-danger small">{{ form.data_inicio.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.data_fim.id_for_label }}" class="form-label fw-bold">
                                {{ form.data_fim.label }}
                            </label>
                            {{ form.data_fim }}
                            {% if form.data_fim.errors %}
                            <div class="text-danger small">{{ form.data_fim.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch ps-5 pt-4">
                                {{ form.ativa }}
                                <label class="form-check-label fw-bold ms-2" for="{{ form.ativa.id_for_label }}">
                                    {{ form.ativa.label }}
                                </label>
                            </div>
                            {% if form.ativa.errors %}
                            <div class="text-danger small">{{ form.ativa.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            üíæ Salvar Comiss√£o
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if object %}
    <div class="col-12">
        <div class="card card-custom border-2 border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">üìã Integrantes Designados</h5>
                <a href="{% url 'nova_designacao_comissao' comissao_id=object.id %}"
                    class="btn btn-light text-primary fw-bold">
                    + Adicionar Integrante
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Militar</th>
                                <th>Fun√ß√£o</th>
                                <th>In√≠cio</th>
                                <th>Fim</th>
                                <th>Boletim</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for integrante in designacoes %}
                            <tr>
                                <td>{{ integrante.agente }}</td>
                                <td>{{ integrante.funcao }}</td>
                                <td>{{ integrante.data_inicio|date:"d/m/Y" }}</td>
                                <td>{{ integrante.data_fim|date:"d/m/Y"|default:"-" }}</td>
                                <td>
                                    {% if integrante.boletim_numero %}
                                    {{ integrante.boletim_numero }} ({{ integrante.boletim_data|date:"d/m/Y" }})
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'editar_designacao_comissao' pk=integrante.pk %}"
                                        class="btn btn-sm btn-outline-secondary" title="Editar">
                                        ‚úèÔ∏è
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    Nenhum integrante designado para esta comiss√£o.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* Estilo para erro de valida√ß√£o estrito */
    .field-error-shadow {
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        border-color: #dc3545 !important;
        transition: all 0.2s ease-in-out;
    }

    .field-side-warning {
        position: absolute;
        top: 0;
        right: -10px;
        transform: translateX(100%);
        background-color: #ffdce0;
        color: #b02a37;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
        z-index: 10;
        display: none;
        border: 1px solid #f5c2c7;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .field-side-warning::before {
        content: '';
        position: absolute;
        top: 50%;
        left: -6px;
        transform: translateY(-50%);
        border-width: 6px 6px 6px 0;
        border-style: solid;
        border-color: transparent #f5c2c7 transparent transparent;
    }

    /* Container relativo para posicionamento */
    .input-wrapper-relative {
        position: relative;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dataFimInput = document.getElementById('{{ form.data_fim.id_for_label }}');
        const ativaInput = document.getElementById('{{ form.ativa.id_for_label }}');

        if (!dataFimInput || !ativaInput) return;

        // Cria o elemento de aviso
        const warningSpan = document.createElement('div');
        warningSpan.className = 'field-side-warning';
        warningSpan.innerText = 'Data inv√°lida para comiss√£o ativa';

        // Envolve o input em um wrapper relativo se ainda n√£o estiver
        const parent = dataFimInput.parentNode;
        parent.classList.add('input-wrapper-relative');
        parent.appendChild(warningSpan);
        parent.style.position = 'relative'; // Garante reset do contexto de empilhamento

        function validateStrict() {
            // Se N√ÉO estiver ativa, limpa erro
            if (!ativaInput.checked) {
                clearValidation();
                return;
            }

            // Se estiver ativa
            const dateValue = dataFimInput.value;
            // Verifica se h√° mensagem de erro do servidor para este campoe esconde
            const serverError = dataFimInput.parentNode.querySelector('.text-danger');
            if (serverError) {
                serverError.style.display = 'none';
                // Se veio com erro do servidor, for√ßamos o estado inv√°lido visual
                // Mesmo que o value possa estar vazio ou n√£o parse√°vel
                if (!dateValue) {
                    // Se est√° vazio mas tem erro de servidor, assume que tentou salvar errado
                    // Mas precisamos saber se √© valida√ß√£o de data futura
                }
            }

            if (dateValue) {
                // Parse manual para evitar problemas de timezone (yyyy-mm-dd)
                const parts = dateValue.split('-');
                let selectedDate = null;
                if (parts.length === 3) {
                    // new Date(y, m, d) cria data local meia-noite
                    selectedDate = new Date(parts[0], parts[1] - 1, parts[2]);
                }

                if (selectedDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        // REGRAS ESTRITAS: Data passada
                        // 1. Limpar campo (mantendo consist√™ncia com intera√ß√£o)
                        dataFimInput.value = '';
                        // 2. Sombreado vermelho
                        dataFimInput.classList.add('field-error-shadow');
                        // 3. Aviso ao lado
                        if (warningSpan) {
                            warningSpan.style.display = 'block';
                            warningSpan.style.top = (dataFimInput.offsetTop + 5) + 'px';
                        }
                    } else {
                        // Se tiver erro de servidor mas a data agora parece v√°lida (usu√°rio corrigiu? n√£o, isso √© apenas leitura)
                        // Limpa erro
                        clearValidation();
                    }
                }
            } else {
                // Se campo vazio
                clearValidation();

                // Exce√ß√£o: Se tiver erro de servidor e estiver vazio (prov√°vel submit sem data ou data inv√°lida limpa pelo browser)
                // Mas a regra estrita s√≥ aplica se "ativa" e data < hoje.
                // Se data for vazia, permitimos (deixamos o usu√°rio preencher).
            }

            // Se tiver erro de servidor E a valida√ß√£o estrita detectou erro (entrou no if), o texto sumiu e o bal√£o apareceu.
            // Se tiver erro de servidor MAS o valor n√£o disparou strict (ex: data futura mas outro erro?), mantemos escondido se for especificamente erro de campo.
            // Para garantir que o estilo visual se mantenha apenas sobre a regra de data passada:

            // Mas espere! Se o server devolve o form com erro, ele devolve o valor POSTado.
            // Se usu√°rio mandou 2000-01-01, o value √© 2000-01-01.
            // O c√≥digo acima vai detectar < today e vai LIMPAR e mostrar erro. Perfeito.
        }

        function clearValidation() {
            dataFimInput.classList.remove('field-error-shadow');
            warningSpan.style.display = 'none';
        }

        // Eventos
        ativaInput.addEventListener('change', validateStrict);
        // Validar data apenas no BLUR
        dataFimInput.addEventListener('blur', validateStrict);

        // Remove erro ao digitar
        dataFimInput.addEventListener('input', function () {
            clearValidation();
        });

        // Executa valida√ß√£o ao carregar a p√°gina (para tratar retorno do servidor com erro)
        // Pequeno delay para garantir renderiza√ß√£o
        setTimeout(validateStrict, 50);
    });
</script>
{% endblock %}